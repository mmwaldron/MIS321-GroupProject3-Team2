<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bio-Isac | Digital Verification</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./styles/main.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-success">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <span class="logo-text">BIO-ISAC</span>
          <span class="logo-accent">.</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html">Verification</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin.html">Admin</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container my-5">
      <!-- User Status Banner (if logged in) -->
      <div class="row justify-content-center mb-4" id="userStatusBanner" style="display: none;">
        <div class="col-lg-8">
          <div class="card border-warning" id="pendingStatusCard">
            <div class="card-body p-4">
              <div class="d-flex align-items-center">
                <i class="bi bi-hourglass-split text-warning me-3" style="font-size: 2rem;"></i>
                <div class="flex-grow-1">
                  <h5 class="mb-1 text-warning">Account Pending Approval</h5>
                  <p class="text-muted mb-0">Your account is pending admin approval. You are logged in, but access is restricted until approved.</p>
                </div>
                <button class="btn btn-outline-warning" onclick="checkAccountStatus()">Check Status</button>
              </div>
            </div>
          </div>
          <div class="card border-success" id="approvedStatusCard" style="display: none;">
            <div class="card-body p-4">
              <div class="d-flex align-items-center">
                <i class="bi bi-check-circle text-success me-3" style="font-size: 2rem;"></i>
                <div class="flex-grow-1">
                  <h5 class="mb-1 text-success">Account Approved</h5>
                  <p class="text-muted mb-2">Your account has been approved! Your passport code is:</p>
                  <div class="mt-2">
                    <code id="passportCodeDisplay" class="bg-dark text-success p-2 rounded" style="font-size: 1.25rem; font-family: 'Courier New', monospace; display: none;"></code>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Passport Code Lookup -->
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body p-4">
              <div class="text-center mb-3">
                <i class="bi bi-passport text-success" style="font-size: 2.5rem;"></i>
                <h4 class="mt-2 mb-1 text-success">Access Your Passport</h4>
                <p class="text-muted mb-0">Upload your QR code or enter your 10-digit passport code</p>
              </div>
              
              <!-- QR Code Upload -->
              <div class="mb-3">
                <label class="form-label">Upload QR Code</label>
                <input
                  type="file"
                  class="form-control bg-dark text-light border-success"
                  id="qrCodeUpload"
                  accept="image/*"
                  onchange="handleQRUpload(event)"
                />
                <small class="text-muted">Upload the QR code file provided by admin</small>
              </div>

              <div class="text-center my-3">
                <span class="text-muted">OR</span>
              </div>

              <!-- Manual Code Entry -->
              <form id="passportCodeForm" onsubmit="lookupPassport(event)">
                <div class="input-group input-group-lg">
                  <input
                    type="text"
                    class="form-control bg-dark text-light border-success text-center"
                    id="passportCodeInput"
                    placeholder="0000000000"
                    maxlength="10"
                    pattern="[0-9]{10}"
                    inputmode="numeric"
                    style="font-size: 1.5rem; letter-spacing: 0.5rem; font-family: 'Courier New', monospace;"
                    oninput="formatPassportCode(this)"
                  />
                  <button class="btn btn-success" type="submit">
                    <i class="bi bi-arrow-right"></i> Access
                  </button>
                </div>
                <small class="text-muted d-block mt-2 text-center">
                  <i class="bi bi-info-circle"></i> You will receive your passport code after admin approval
                </small>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Verification Section -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card verification-card">
            <div class="card-body p-4">
              <div class="text-center mb-4">
                <div class="logo-icon mb-3">
                  <i class="bi bi-shield-check"></i>
                </div>
                <h1 class="h3 mb-2 text-success">Digital Verification</h1>
                <p class="text-muted">Complete verification to receive your BioTrust Passport</p>
              </div>

              <!-- Verification Steps -->
              <div id="verificationSteps" class="verification-steps">
                <!-- Step 1: Basic Info -->
                <div class="step active" id="step1">
                  <h5 class="step-title">
                    <span class="step-number">1</span>
                    Personal Information
                  </h5>
                  <form id="basicInfoForm">
                    <div class="mb-3">
                      <label class="form-label">Full Name</label>
                      <input
                        type="text"
                        class="form-control bg-dark text-light border-success"
                        id="fullName"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Email</label>
                      <input
                        type="email"
                        class="form-control bg-dark text-light border-success"
                        id="email"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Phone Number</label>
                      <input
                        type="tel"
                        class="form-control bg-dark text-light border-success"
                        id="phone"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Organization</label>
                      <input
                        type="text"
                        class="form-control bg-dark text-light border-success"
                        id="organization"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                      Continue <i class="bi bi-arrow-right"></i>
                    </button>
                  </form>
                </div>

                <!-- Step 2: Digital Credentials -->
                <div class="step" id="step2" style="display: none">
                  <h5 class="step-title">
                    <span class="step-number">2</span>
                    Digital Credentials
                  </h5>
                  <form id="credentialsForm">
                    <div class="mb-3">
                      <label class="form-label">Government ID Number</label>
                      <input
                        type="text"
                        class="form-control bg-dark text-light border-success"
                        id="govId"
                        placeholder="Last 4 digits"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Verification Document</label>
                      <input
                        type="file"
                        class="form-control bg-dark text-light border-success"
                        id="verificationDoc"
                        accept=".pdf,.jpg,.png"
                      />
                      <small class="text-muted">Upload ID or verification document</small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Company Email Address</label>
                      <input
                        type="email"
                        class="form-control bg-dark text-light border-success"
                        id="companyEmail"
                        placeholder="your.email@company.com"
                        required
                      />
                      <small class="text-muted">We'll send a verification code to this email</small>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                        Back
                      </button>
                      <button type="submit" class="btn btn-success flex-grow-1">
                        Send Verification Code <i class="bi bi-arrow-right"></i>
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Step 2.5: Email Verification Code -->
                <div class="step" id="step2_5" style="display: none">
                  <h5 class="step-title">
                    <span class="step-number">2.5</span>
                    Email Verification
                  </h5>
                  <div class="mb-4 text-center">
                    <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">We've sent a verification code to <strong id="emailDisplay"></strong></p>
                  </div>
                  <form id="emailVerificationForm">
                    <div class="mb-3">
                      <label class="form-label">Verification Code</label>
                      <input
                        type="text"
                        class="form-control bg-dark text-light border-success text-center"
                        id="emailVerificationCode"
                        maxlength="8"
                        placeholder="Enter code"
                        style="font-size: 1.25rem; letter-spacing: 0.25rem; font-family: 'Courier New', monospace;"
                        required
                      />
                      <small class="text-muted d-block mt-2 text-center">Code expires in 10 minutes</small>
                    </div>
                    <div class="mb-3">
                      <button
                        type="button"
                        class="btn btn-link text-success p-0"
                        id="resendEmailCode"
                      >
                        Resend Code
                      </button>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                        Back
                      </button>
                      <button type="submit" class="btn btn-success flex-grow-1">
                        Verify Email <i class="bi bi-shield-check"></i>
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Step 2.75: CAPTCHA Verification -->
                <div class="step" id="step2_75" style="display: none">
                  <h5 class="step-title">
                    <span class="step-number">2.75</span>
                    Security Verification
                  </h5>
                  <div class="mb-4 text-center">
                    <i class="bi bi-shield-lock text-success" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Please complete the security verification below</p>
                  </div>
                  <form id="captchaForm">
                    <div class="mb-4 d-flex justify-content-center">
                      <div id="captchaContainer"></div>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2.5)">
                        Back
                      </button>
                      <button type="submit" class="btn btn-success flex-grow-1" id="captchaSubmitBtn" disabled>
                        Continue <i class="bi bi-arrow-right"></i>
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Step 3: MFA -->
                <div class="step" id="step3" style="display: none">
                  <h5 class="step-title">
                    <span class="step-number">3</span>
                    Multi-Factor Authentication
                  </h5>
                  <div class="mfa-container">
                    <div class="mb-4 text-center">
                      <div class="mfa-code-display" id="mfaCode">----</div>
                      <p class="text-muted mt-2">Enter the code sent to your email</p>
                    </div>
                    <form id="mfaForm">
                      <div class="mb-3">
                        <label class="form-label">Verification Code</label>
                        <input
                          type="text"
                          class="form-control bg-dark text-light border-success text-center"
                          id="mfaInput"
                          maxlength="4"
                          placeholder="0000"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <button
                          type="button"
                          class="btn btn-link text-success p-0"
                          id="resendCode"
                        >
                          Resend Code
                        </button>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                          Back
                        </button>
                        <button type="submit" class="btn btn-success flex-grow-1">
                          Verify <i class="bi bi-shield-check"></i>
                        </button>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Step 4: Processing -->
                <div class="step" id="step4" style="display: none">
                  <div class="text-center py-5">
                    <div class="processing-spinner mb-4">
                      <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Processing...</span>
                      </div>
                    </div>
                    <h5 class="mb-3">Processing Verification</h5>
                    <p class="text-muted">Running risk analysis and security checks...</p>
                    <div class="progress mt-4" style="height: 4px">
                      <div
                        class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                        role="progressbar"
                        style="width: 0%"
                        id="progressBar"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Step 5: Result -->
                <div class="step" id="step5" style="display: none">
                  <div class="text-center py-4">
                    <div class="result-icon mb-4" id="resultIcon"></div>
                    <h4 id="resultTitle" class="mb-3"></h4>
                    <p id="resultMessage" class="text-muted mb-4"></p>
                    <div id="resultActions"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Trust Score Display (after verification) -->
          <div class="card mt-4 trust-score-card" id="trustScoreCard" style="display: none">
            <div class="card-body">
              <h6 class="card-title">Your Trust Score</h6>
              <div class="trust-score-display">
                <div class="score-circle" id="scoreCircle">
                  <span id="trustScoreValue">0</span>
                </div>
                <div class="score-details">
                  <div class="score-tier" id="scoreTier">Tier 1</div>
                  <div class="score-access" id="scoreAccess">Basic Access</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Notifications -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Google reCAPTCHA v2 -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <!-- jsQR Library for QR code decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <!-- Bootstrap JS bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Custom JS -->
    <script src="./scripts/apiConfig.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/riskFilter.js"></script>
    <script src="./scripts/trustScore.js"></script>
    <script>
      // Redirect logged-in users to dashboard immediately (before other scripts load)
      (function() {
        const userId = localStorage.getItem('currentUserId');
        if (userId) {
          // User is logged in, redirect to dashboard immediately
          window.location.replace('dashboard.html');
        }
      })();
      
      // Make logout function available globally
      function logout() {
        localStorage.removeItem('currentUserId');
        localStorage.removeItem('currentPassportCode');
        localStorage.removeItem('currentUserEmail');
        localStorage.removeItem('userStatus');
        localStorage.removeItem('verificationId');
        window.location.href = 'index.html';
      }
    </script>
    <script src="./scripts/verification.js"></script>
    <script src="./scripts/main.js"></script>
  </body>
</html>

